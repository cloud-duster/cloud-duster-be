name: Cleanup Old Memories

on:
  schedule:
    # Runs at 00:00 UTC every day
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        npm ci
        npm install -g axios
      env:
        NODE_ENV: production
    
    - name: Run cleanup script
      run: |
        NODE_ENV=production node -e "
          const axios = require('axios');
          const url = process.env.API_URL + '/batch/cleanup-old-memories';
          
          axios.post(url, {}, {
            headers: { 
              'Content-Type': 'application/json',
              'x-batch-secret': process.env.BATCH_JOB_SECRET
            }
          })
          .then(response => console.log('Cleanup successful:', response.data))
          .catch(error => {
            console.error('Cleanup failed:', error.response?.data || error.message);
            process.exit(1);
          });
        "
      env:
        NODE_ENV: production
        API_URL: ${{ secrets.API_URL }}
        BATCH_JOB_SECRET: ${{ secrets.BATCH_JOB_SECRET }}
